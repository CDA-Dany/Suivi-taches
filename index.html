<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi des Tâches</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { display: flex; gap: 40px; }
    .column { flex: 1; }
    h2 { text-align: center; }
    .bar-container { background: #eee; border-radius: 10px; overflow: hidden; margin: 10px 0; }
    .bar { height: 20px; transition: width 0.3s ease; }
    .project { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h1>Suivi des tâches</h1>
  <div class="container">
    <div class="column">
      <h2>Dany</h2>
      <ul id="dany"></ul>
    </div>
    <div class="column">
      <h2>Pierre</h2>
      <ul id="pierre"></ul>
    </div>
  </div>

  <h2>Suivi des Projets</h2>
  <div id="projets"></div>

  <script>
    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return text.split('\n').map(row => row.split(','));
    }

    function renderTasks(data, targetId) {
      const list = document.getElementById(targetId);
      data.forEach(row => {
        if (row[1]?.toLowerCase() === "en cours") {
          const li = document.createElement("li");
          li.textContent = row[0];
          list.appendChild(li);
        }
      });
    }

    function renderProgressBar(project, phases) {
      const total = phases.length;
      let done = 0;
      let color = "#4caf50"; // par défaut vert

      phases.forEach(phase => {
        const val = phase?.toLowerCase().trim();
        if (val === "terminé" || val === "terminée") {
          done++;
        } else if (val === "bloqué") {
          color = "#f44336";
        } else if (val === "en attente" && color !== "#f44336") {
          color = "#ff9800";
        } else if (val === "en cours" && !["#f44336", "#ff9800"].includes(color)) {
          color = "#2196f3";
        }
      });

      const pourcentage = (done / total) * 100;

      const div = document.createElement("div");
      div.className = "project";
      div.innerHTML = `
        <strong>${project}</strong>
        <div class="bar-container">
          <div class="bar" style="width: ${pourcentage}%; background: ${color};"></div>
        </div>
      `;
      document.getElementById("projets").appendChild(div);
    }

    async function main() {
      const danyData = await fetchCSV("https://docs.google.com/spreadsheets/d/e/2PACX-1vTjhn9zLttac-i4uLNhzuvtyg-TnkUAUXHmDIL_l21zRt1IwYKVapzhDxY83PK081H1O5nWo5UP43jz/pub?gid=0&single=true&output=csv");
      const pierreData = await fetchCSV("https://docs.google.com/spreadsheets/d/e/2PACX-1vTjhn9zLttac-i4uLNhzuvtyg-TnkUAUXHmDIL_l21zRt1IwYKVapzhDxY83PK081H1O5nWo5UP43jz/pub?gid=1909061419&single=true&output=csv");
      const projetData = await fetchCSV("https://docs.google.com/spreadsheets/d/e/2PACX-1vTjhn9zLttac-i4uLNhzuvtyg-TnkUAUXHmDIL_l21zRt1IwYKVapzhDxY83PK081H1O5nWo5UP43jz/pub?gid=830233333&single=true&output=csv");

      renderTasks(danyData.slice(1), "dany");
      renderTasks(pierreData.slice(1), "pierre");

      projetData.slice(1).forEach(row => {
        const projet = row[0];
        const phases = row.slice(3, 9); // D à I inclus
        if (projet) renderProgressBar(projet, phases);
      });

      setTimeout(() => location.reload(), 15000); // Actualisation toutes les 15 sec
    }

    main();
  </script>
</body>
</html>
